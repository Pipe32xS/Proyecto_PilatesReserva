{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}PilatesReserva{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <!-- en <head> -->
  <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>

  <!-- Chatbot CSS externo -->
  <link rel="stylesheet" href="{% static 'css/chatbot.css' %}">
</head>
<body class="d-flex flex-column min-vh-100 chat-theme--glass">

  <!-- CSRF token accesible para JS -->
  <div id="csrf-token" style="display:none">{% csrf_token %}</div>

  <!-- TOP BAR con el degradado azul-morado -->
  <div style="background: linear-gradient(90deg, #00c6ff, #7d5fff); color: white;">
    <div class="container d-flex justify-content-between align-items-center flex-wrap py-2 small">

      <!-- Logo y nombre -->
      <div class="d-flex align-items-center gap-2">
        <img src="https://cdn-icons-png.flaticon.com/512/1048/1048953.png"
             alt="Logo" width="34" height="34"
             class="rounded-circle border border-light p-1"
             style="background: rgba(255,255,255,0.15);">
        <strong class="fs-5">PilatesReserva</strong>
      </div>

      <!-- Información de contacto -->
      <div class="d-flex align-items-center flex-wrap gap-3">
        <span class="d-flex align-items-center gap-2">
          <span class="rounded-circle d-flex align-items-center justify-content-center"
                style="width:30px;height:30px;background: rgba(255,255,255,0.2);">
            <i class="bi bi-geo-alt-fill fs-6"></i>
          </span>
          <span>Ubicación</span>
        </span>

        <a href="tel:+56912345678" class="d-flex align-items-center gap-2 text-decoration-none text-white">
          <span class="rounded-circle d-flex align-items-center justify-content-center"
                style="width:30px;height:30px;background: rgba(255,255,255,0.2);">
            <i class="bi bi-telephone-fill fs-6"></i>
          </span>
          <span>+56 9 1234 5678</span>
        </a>

        <a href="mailto:contacto@pilatesreserva.cl" class="d-flex align-items-center gap-2 text-decoration-none text-white">
          <span class="rounded-circle d-flex align-items-center justify-content-center"
                style="width:30px;height:30px;background: rgba(255,255,255,0.2);">
            <i class="bi bi-envelope-fill fs-6"></i>
          </span>
          <span>contacto@pilatesreserva.cl</span>
        </a>
      </div>
    </div>
  </div>

  {% with current=request.resolver_match.url_name|default:"" %}
  <!-- Accent bar superior -->
  <div style="height:4px; background:linear-gradient(90deg,#0dcaf0,#6f42c1);"></div>

  <!-- Navbar “glass” -->
  <nav class="navbar navbar-expand-lg sticky-top border-0 py-3"
       style="background: rgba(255,255,255,.75); backdrop-filter: blur(10px); box-shadow: 0 6px 24px rgba(0,0,0,.06);">
    <div class="container justify-content-center">

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavGlass"
              aria-controls="navbarNavGlass" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-center" id="navbarNavGlass">
        <ul class="navbar-nav align-items-center gap-2">

          <!-- Inicio -->
          <li class="nav-item">
            <a
              class="nav-link fw-semibold rounded-3 px-4 py-2
                {% if current == 'index' %} active bg-info text-white {% else %} bg-info-subtle text-dark {% endif %}"
              href="{% url 'index:index' %}"
              style="transition:.2s; box-shadow: {% if current == 'index' %}0 8px 18px rgba(13,202,240,.25){% else %}none{% endif %};"
              onmouseenter="this.style.transform='translateY(-2px)';"
              onmouseleave="this.style.transform='none';">
              <i class="bi bi-house-door me-2"></i>Inicio
            </a>
          </li>

          <!-- Contacto -->
          <li class="nav-item">
            <a
              class="nav-link fw-semibold rounded-3 px-4 py-2
                {% if current == 'contacto_publico' %} active bg-info text-white {% else %} bg-info-subtle text-dark {% endif %}"
              href="{% url 'index:contacto_publico' %}"
              style="transition:.2s; box-shadow: {% if current == 'contacto_publico' %}0 8px 18px rgba(13,202,240,.25){% else %}none{% endif %};"
              onmouseenter="this.style.transform='translateY(-2px)';"
              onmouseleave="this.style.transform='none';">
              <i class="bi bi-chat-dots me-2"></i>Contacto
            </a>
          </li>

          <!-- Clases -->
          <li class="nav-item">
            <a
              class="nav-link fw-semibold rounded-3 px-4 py-2
                {% if current == 'clases' %} active bg-info text-white {% else %} bg-info-subtle text-dark {% endif %}"
              href="{% url 'index:clases' %}"
              style="transition:.2s; box-shadow: {% if current == 'clases' %}0 8px 18px rgba(13,202,240,.25){% else %}none{% endif %};"
              onmouseenter="this.style.transform='translateY(-2px)';"
              onmouseleave="this.style.transform='none';">
              <i class="bi bi-grid-3x3-gap me-2"></i>Clases
            </a>
          </li>

          <!-- Login (namespace correcto) -->
          <li class="nav-item">
            <a
              class="nav-link fw-semibold rounded-3 px-4 py-2
                {% if current == 'login' %} active bg-info text-white {% else %} bg-info-subtle text-dark {% endif %}"
              href="{% url 'login:login' %}"
              style="transition:.2s; box-shadow: {% if current == 'login' %}0 8px 18px rgba(13,202,240,.25){% else %}none{% endif %};"
              onmouseenter="this.style.transform='translateY(-2px)';"
              onmouseleave="this.style.transform='none';">
              <i class="bi bi-box-arrow-in-right me-2"></i>Login
            </a>
          </li>

        </ul>
      </div>

    </div>
  </nav>
  {% endwith %}

  <!-- Contenido dinámico -->
  {% block content %}{% endblock %}

  <!-- Footer -->
  <footer class="text-white mt-auto" style="background: radial-gradient(1200px 400px at 20% -10%, rgba(13,202,240,.10), transparent), radial-gradient(1000px 380px at 90% -20%, rgba(111,66,193,.12), transparent), rgba(10,12,14,.92); backdrop-filter: blur(8px); position: relative; overflow: hidden;">
    <div style="height:4px; background: linear-gradient(90deg, #0dcaf0, #6f42c1);"></div>

    <div class="container py-5">
      <div class="row g-5">
        <!-- Marca + descripción + redes -->
        <div class="col-12 col-md-5">
          <div class="d-flex align-items-center gap-2 mb-3">
            <div class="d-inline-flex align-items-center justify-content-center rounded-circle"
                 style="width:40px;height:40px;background: rgba(13,202,240,.18);">
              <i class="bi bi-heart-pulse-fill" style="color:#0dcaf0;"></i>
            </div>
            <h4 class="m-0 fw-bold" style="letter-spacing:.3px;">PilatesReserva</h4>
          </div>
          <p class="mb-3 text-white-50">
            Plataforma de reservas para clases de Pilates. Fácil, rápida y pensada para todos los niveles.  
            Encuentra tu equilibrio con Mat, Reformer o clases grupales.
          </p>

          <div class="d-flex flex-wrap gap-2">
            <a href="#" class="btn btn-sm border-0 rounded-circle d-inline-flex align-items-center justify-content-center"
               aria-label="Facebook"
               style="width:42px;height:42px;background: rgba(255,255,255,.08); color:#0dcaf0; transition:all .25s;"
               onmouseenter="this.style.transform='translateY(-3px)'; this.style.filter='brightness(1.15)';"
               onmouseleave="this.style.transform='none'; this.style.filter='none';">
              <i class="bi bi-facebook"></i>
            </a>
            <a href="#" class="btn btn-sm border-0 rounded-circle d-inline-flex align-items-center justify-content-center"
               aria-label="Instagram"
               style="width:42px;height:42px;background: rgba(255,255,255,.08); color:#0dcaf0; transition:all .25s;"
               onmouseenter="this.style.transform='translateY(-3px)'; this.style.filter='brightness(1.15)';"
               onmouseleave="this.style.transform='none'; this.style.filter='none';">
              <i class="bi bi-instagram"></i>
            </a>
            <a href="#" class="btn btn-sm border-0 rounded-circle d-inline-flex align-items-center justify-content-center"
               aria-label="Twitter"
               style="width:42px;height:42px;background: rgba(255,255,255,.08); color:#0dcaf0; transition:all .25s;"
               onmouseenter="this.style.transform='translateY(-3px)'; this.style.filter='brightness(1.15)';"
               onmouseleave="this.style.transform='none'; this.style.filter='none';">
              <i class="bi bi-twitter"></i>
            </a>
            <a href="#" class="btn btn-sm border-0 rounded-circle d-inline-flex align-items-center justify-content-center"
               aria-label="YouTube"
               style="width:42px;height:42px;background: rgba(255,255,255,.08); color:#0dcaf0; transition:all .25s;"
               onmouseenter="this.style.transform='translateY(-3px)'; this.style.filter='brightness(1.15)';"
               onmouseleave="this.style.transform='none'; this.style.filter='none';">
              <i class="bi bi-youtube"></i>
            </a>
            <a href="#" class="btn btn-sm border-0 rounded-circle d-inline-flex align-items-center justify-content-center"
               aria-label="WhatsApp"
               style="width:42px;height:42px;background: rgba(255,255,255,.08); color:#0dcaf0; transition:all .25s;"
               onmouseenter="this.style.transform='translateY(-3px)'; this.style.filter='brightness(1.15)';"
               onmouseleave="this.style.transform='none'; this.style.filter='none';">
              <i class="bi bi-whatsapp"></i>
            </a>
          </div>
        </div>

        <!-- Enlaces rápidos -->
        <div class="col-6 col-md-3">
          <h6 class="text-uppercase mb-3" style="letter-spacing:.08em; color:#96e8f7;">Enlaces</h6>
          <ul class="list-unstyled m-0">
            <li class="mb-2">
              <a href="{% url 'index:index' %}" class="link-light text-decoration-none footer-link">
                <i class="bi bi-house-door me-2"></i>Inicio
              </a>
            </li>
            <li class="mb-2">
              <a href="{% url 'index:clases' %}?tipo=reformer" class="link-light text-decoration-none footer-link">
                <i class="bi bi-bounding-box-circles me-2"></i>Reformer
              </a>
            </li>
            <li class="mb-2">
              <a href="{% url 'index:clases' %}?tipo=mat" class="link-light text-decoration-none footer-link">
                <i class="bi bi-grid-3x3-gap me-2"></i>Mat
              </a>
            </li>
            <li class="mb-2">
              <a href="{% url 'index:clases' %}?tipo=grupal" class="link-light text-decoration-none footer-link">
                <i class="bi bi-people me-2"></i>Grupal
              </a>
            </li>
            <li>
              <a href="{% url 'index:contacto_publico' %}" class="link-light text-decoration-none footer-link">
                <i class="bi bi-envelope me-2"></i>Contacto
              </a>
            </li>
          </ul>
        </div>

        <!-- Contacto -->
        <div class="col-6 col-md-4">
          <h6 class="text-uppercase mb-3" style="letter-spacing:.08em; color:#96e8f7;">Contáctanos</h6>
          <ul class="list-unstyled m-0">
            <li class="mb-2 text-white-50"><i class="bi bi-geo-alt-fill me-2" style="color:#0dcaf0;"></i>Santiago, Chile</li>
            <li class="mb-2 text-white-50"><i class="bi bi-telephone-fill me-2" style="color:#0dcaf0;"></i>+56 9 1234 5678</li>
            <li class="text-white-50"><i class="bi bi-envelope-fill me-2" style="color:#0dcaf0;"></i>contacto@pilatesreserva.cl</li>
          </ul>
          <div class="mt-3">
            <a href="{% url 'login:login' %}" class="btn btn-sm text-white fw-semibold rounded-3"
               style="background: linear-gradient(90deg, #0dcaf0, #6f42c1); border:0; transition:all .25s;"
               onmouseenter="this.style.filter='brightness(1.08)'; this.style.transform='translateY(-2px)';"
               onmouseleave="this.style.filter='none'; this.style.transform='none';">
              <i class="bi bi-box-arrow-in-right me-1"></i> Ingresar
            </a>
          </div>
        </div>
      </div>

      <hr class="border border-light-subtle opacity-25 my-4">

      <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
        <small class="opacity-75 mb-0">&copy; <span id="year"></span> PilatesReserva. Todos los derechos reservados.</small>
        <div class="d-flex align-items-center gap-3">
          <a href="#" class="link-light text-decoration-none opacity-75"
             onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.75'">Términos</a>
          <span class="opacity-25">|</span>
          <a href="#" class="link-light text-decoration-none opacity-75"
             onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.75'">Privacidad</a>
          <span class="opacity-25">|</span>
          <a href="#" class="link-light text-decoration-none opacity-75"
             onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='.75'">Soporte</a>
        </div>
      </div>
    </div>

    <button type="button" aria-label="Volver arriba"
            class="btn btn-light border-0 shadow position-fixed"
            style="right: 16px; bottom: 16px; border-radius: 999px; width: 46px; height: 46px; transition: transform .2s; z-index: 1040;"
            onclick="window.scrollTo({top:0, behavior:'smooth'})"
            onmouseenter="this.style.transform='translateY(-3px)';"
            onmouseleave="this.style.transform='none';">
      <i class="bi bi-arrow-up"></i>
    </button>

    <style>
      .footer-link { opacity:.78; transition: all .2s ease; }
      .footer-link:hover { opacity:1; padding-left:.25rem; color:#0dcaf0 !important; }
    </style>

    <script>
      (function(){ const y = document.getElementById('year'); if (y) y.textContent = new Date().getFullYear(); })();
    </script>
  </footer>

  <!-- ===================== CHATBOT WIDGET ===================== -->
  <!-- en el FAB -->
<button id="chatFab" title="Chatear" aria-label="Abrir chat">
  <span class="iconify" data-icon="teenyicons:robot-solid"></span>
</button>


  <div id="chatBox" role="dialog" aria-label="Asistente Pilates">
    <header>
      <div>
        <div class="fw-semibold">Asistente Pilates</div>
        <small class="opacity-75">Estoy para ayudarte ✨</small>
      </div>
      <button class="btn btn-sm btn-light" id="chatClose" aria-label="Cerrar"><i class="bi bi-x"></i></button>
    </header>
    <div id="chatMsgs"></div>
    <form id="chatForm" autocomplete="off">
      <input id="chatInput" type="text" placeholder="Escribe tu mensaje..." />
      <button id="chatSend" type="submit"><i class="bi bi-send"></i> Enviar</button>
    </form>
  </div>

  <script>
    (function(){
      const ENDPOINT = "{% url 'index:chat_api' %}";
      const box = document.getElementById('chatBox');
      const fab = document.getElementById('chatFab');
      const closeBtn = document.getElementById('chatClose');
      const msgs = document.getElementById('chatMsgs');
      const form = document.getElementById('chatForm');
      const input = document.getElementById('chatInput');
      const STORAGE_KEY = 'pr-chat-history';

      // --- helpers: escapar + linkify (para links clickeables) ---
      function esc(s){
        return (s || "").replace(/[&<>"']/g, ch => (
          { "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[ch]
        ));
      }
      function linkify(text){
        const urlRe = /(https?:\/\/[^\s<>"']+)/g;
        return text.replace(urlRe, url =>
          `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`
        );
      }
      function toHtml(text){
        return linkify(esc(text).replace(/\n/g, "<br>"));
      }

      function getCSRF(){
        const n = document.querySelector('#csrf-token input[name=csrfmiddlewaretoken]');
        if(n && n.value) return n.value;
        const m = document.cookie.match(/(^|;)\s*csrftoken=([^;]+)/);
        return m ? decodeURIComponent(m[2]) : '';
      }

      function saveHistory(){
        try{
          const data = Array.from(msgs.querySelectorAll('.bubble')).map(b => ({
            t: b.classList.contains('me-bubble') ? 'me':'bot',
            m: b.innerText
          }));
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }catch(e){}
      }
      function loadHistory(){
        try{
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return;
          const arr = JSON.parse(raw);
          arr.forEach(o => appendBubble(o.m, o.t === 'me'));
          scrollToBottom();
        }catch(e){}
      }

      function appendBubble(text, isMe){
        const div = document.createElement('div');
        div.className = 'bubble ' + (isMe ? 'me-bubble':'bot-bubble');
        div.innerHTML = toHtml(text);
        msgs.appendChild(div);
        saveHistory();
      }

      function scrollToBottom(){ msgs.scrollTop = msgs.scrollHeight; }
      function toggle(open){ box.style.display = open ? 'block' : 'none'; if(open){ setTimeout(()=>input.focus(), 100);} }

      fab.addEventListener('click', ()=> toggle(true));
      closeBtn.addEventListener('click', ()=> toggle(false));

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const text = (input.value || '').trim();
        if(!text) return;
        appendBubble(text, true);
        input.value = '';
        scrollToBottom();

        const wait = document.createElement('div');
        wait.className = 'bubble bot-bubble';
        wait.textContent = '…';
        msgs.appendChild(wait);
        scrollToBottom();

        try{
          const res = await fetch(ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCSRF() },
            body: JSON.stringify({ message: text })
          });
          msgs.removeChild(wait);

          if(res.ok){
            const data = await res.json();
            appendBubble(data.reply || 'Gracias por tu mensaje.', false);
          }else{
            appendBubble('Lo siento, no pude responder ahora. Intenta más tarde.', false);
          }
        }catch(err){
          try{ msgs.removeChild(wait); }catch(_){}
          appendBubble('Hubo un problema de conexión. Intenta nuevamente.', false);
        }
        scrollToBottom();
      });

      input.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          form.requestSubmit();
        }
      });

      loadHistory();
      if(!msgs.children.length){
        appendBubble('¡Hola! Soy tu asistente de Pilates 🤸‍♀️\nPregúntame por horarios, precios, ubicación o cómo reservar.', false);
      }
    })();
  </script>
  <!-- =================== /CHATBOT WIDGET =================== -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
