{% load dict_extras %}

{# lista puede ser una lista de ClasePilates o una lista de dicts con "obj" #}
<div class="row g-3">
  {% for it in lista %}
    {% if it.obj %}
      {% with c=it.obj %}
        {% with reservados=reservas_por_clase|get_item:c.id %}
          {% with libres=c.capacidad_maxima|sub:reservados %}
            <div class="col-12 col-sm-6 col-lg-4">
              <div class="card h-100 shadow-sm">
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title mb-1">{{ c.nombre_clase }}</h5>
                  <div class="small text-muted mb-2">
                    {{ c.fecha|date:"M j, Y" }} — {{ c.horario|time:"H:i" }}
                  </div>

                  <div class="mb-2">
                    <span class="badge rounded-pill" style="background:#e8f5e9;color:#1b5e20;">
                      Cupos: {{ c.capacidad_maxima }} | Libres: {{ libres }}
                    </span>
                  </div>

                  {% if c.nombre_instructor %}
                    <div class="small mb-2"><strong>Instructor:</strong> {{ c.nombre_instructor }}</div>
                  {% endif %}

                  {% if c.descripcion %}
                    <p class="text-muted mb-3" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
                      {{ c.descripcion }}
                    </p>
                  {% else %}
                    <div class="mb-3"></div>
                  {% endif %}

                  <div class="mt-auto d-grid">
                    {% if libres|gt:0 %}
                      <a class="btn btn-primary" href="{% url reserve_url_name c.id %}">Reservar</a>
                    {% else %}
                      <button class="btn btn-secondary" disabled>Sin cupos</button>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endwith %}
        {% endwith %}
      {% endwith %}
    {% else %}
      {# it es instancia de ClasePilates directamente #}
      {% with c=it reservados=reservas_por_clase|get_item:it.id %}
        {% with libres=c.capacidad_maxima|sub:reservados %}
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="card h-100 shadow-sm">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title mb-1">{{ c.nombre_clase }}</h5>
                <div class="small text-muted mb-2">
                  {{ c.fecha|date:"M j, Y" }} — {{ c.horario|time:"H:i" }}
                </div>

                <div class="mb-2">
                  <span class="badge rounded-pill" style="background:#e8f5e9;color:#1b5e20;">
                    Cupos: {{ c.capacidad_maxima }} | Libres: {{ libres }}
                  </span>
                </div>

                {% if c.nombre_instructor %}
                  <div class="small mb-2"><strong>Instructor:</strong> {{ c.nombre_instructor }}</div>
                {% endif %}

                {% if c.descripcion %}
                  <p class="text-muted mb-3" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
                    {{ c.descripcion }}
                  </p>
                {% else %}
                  <div class="mb-3"></div>
                {% endif %}

                <div class="mt-auto d-grid">
                  {% if libres|gt:0 %}
                    <a class="btn btn-primary" href="{% url reserve_url_name c.id %}">Reservar</a>
                  {% else %}
                    <button class="btn btn-secondary" disabled>Sin cupos</button>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endwith %}
      {% endwith %}
    {% endif %}
  {% endfor %}
</div>

