{% extends 'usuarios/base_usuarios.html' %}
{% block title %}Mis reservas | PilatesReserva{% endblock %}

{% block content %}
<section class="position-relative">
  <div style="height:4px; background:linear-gradient(90deg,#0dcaf0,#6f42c1);"></div>
  <div class="container-fluid px-0 py-4">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
      <div>
        <h1 class="fw-bold mb-1">Mis reservas</h1>
        <p class="text-secondary mb-0">Revisa tus prÃ³ximas clases y tu historial.</p>
      </div>
      <div class="d-flex gap-2">
        <!-- AHORA apunto a clases del admin -->
        <a href="{% url 'usuarios:clases_disponibles' %}" class="btn btn-info text-dark fw-semibold px-4"
           style="border:1px solid rgba(13,202,240,.5)">
          <i class="bi bi-calendar2-plus me-1"></i> Nueva reserva
        </a>
        <a href="" class="btn btn-outline-secondary" onclick="location.reload();return false;">
          <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
        </a>
      </div>
    </div>
  </div>
</section>

<section class="pt-2">
  <!-- Tarjetas resumen -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-uppercase small text-secondary">PrÃ³ximas</div>
            <div class="h4 m-0">{{ total_proximas|default:"0" }}</div>
          </div>
          <i class="bi bi-calendar2-check text-info" style="font-size:1.6rem;"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-uppercase small text-secondary">Historial</div>
            <div class="h4 m-0">{{ total_historial|default:"0" }}</div>
          </div>
          <i class="bi bi-clock-history text-primary" style="font-size:1.6rem;"></i>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-uppercase small text-secondary">Canceladas</div>
            <div class="h4 m-0">{{ total_canceladas|default:"0" }}</div>
          </div>
          <i class="bi bi-x-circle text-danger" style="font-size:1.6rem;"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-pills gap-2 mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-proximas" data-bs-toggle="pill" data-bs-target="#pane-proximas" type="button" role="tab">
        PrÃ³ximas
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-historial" data-bs-toggle="pill" data-bs-target="#pane-historial" type="button" role="tab">
        Historial
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- PrÃ³ximas -->
    <div class="tab-pane fade show active" id="pane-proximas" role="tabpanel" aria-labelledby="tab-proximas">
      {% if reservas_proximas %}
        <div class="table-responsive shadow-sm rounded">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Tipo de clase</th>
                <th>Estado</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for r in reservas_proximas %}
              <tr>
                <td>{{ r.fecha|date:"d/m/Y" }}</td>
                <td>{{ r.inicio }}{% if r.fin %} â€“ {{ r.fin }}{% endif %}</td>
                <td>{{ r.tipo|default:"-" }}</td>
                <td>
                  <span class="badge {% if r.estado == 'Confirmada' %}text-bg-success{% elif r.estado == 'Pendiente' %}text-bg-warning{% else %}text-bg-secondary{% endif %}">
                    {{ r.estado|default:"Confirmada" }}
                  </span>
                </td>
                <td class="text-end">
                  <a href="{% url 'usuarios:reserva_detalle' r.id %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-eye me-1"></i> Ver
                  </a>
                  <button type="button"
                          class="btn btn-outline-danger btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#modalCancelar"
                          data-cancel-url="{% url 'usuarios:reserva_cancelar' r.id %}">
                    <i class="bi bi-x-lg me-1"></i> Cancelar
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center py-5">
            <div class="display-6 mb-2">ðŸ˜Œ</div>
            <h5 class="fw-semibold">AÃºn no tienes reservas prÃ³ximas</h5>
            <p class="text-secondary mb-4">Cuando reserves una clase, la verÃ¡s aquÃ­.</p>
            <!-- TambiÃ©n apunta a clases del admin -->
            <a href="{% url 'usuarios:clases_disponibles' %}" class="btn btn-info text-dark fw-semibold px-4">
              <i class="bi bi-calendar2-plus me-1"></i> Reservar ahora
            </a>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Historial -->
    <div class="tab-pane fade" id="pane-historial" role="tabpanel" aria-labelledby="tab-historial">
      {% if reservas_historial %}
        <div class="table-responsive shadow-sm rounded">
          <table class="table align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Tipo de clase</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              {% for r in reservas_historial %}
              <tr>
                <td>{{ r.fecha|date:"d/m/Y" }}</td>
                <td>{{ r.inicio }}{% if r.fin %} â€“ {{ r.fin }}{% endif %}</td>
                <td>{{ r.tipo|default:"-" }}</td>
                <td>
                  <span class="badge {% if r.estado == 'Completada' %}text-bg-secondary{% elif r.estado == 'Cancelada' %}text-bg-danger{% else %}text-bg-light text-dark{% endif %}">
                    {{ r.estado|default:"Completada" }}
                  </span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center py-5">
            <h5 class="fw-semibold mb-1">Sin clases en tu historial</h5>
            <p class="text-secondary mb-0">Cuando termines una clase, aparecerÃ¡ aquÃ­.</p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<!-- Modal cancelar -->
<div class="modal fade" id="modalCancelar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cancelar reserva</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">Â¿Seguro que deseas cancelar esta reserva?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        <a id="confirmCancel" href="#" class="btn btn-danger">Cancelar reserva</a>
      </div>
    </div>
  </div>
</div>

<script>
  // Cargar en el botÃ³n rojo del modal la URL que viene del botÃ³n de la fila
  const modal = document.getElementById('modalCancelar');
  modal?.addEventListener('show.bs.modal', (ev) => {
    const triggerBtn = ev.relatedTarget;
    const url = triggerBtn?.getAttribute('data-cancel-url');
    const confirm = document.getElementById('confirmCancel');
    if (url && confirm) confirm.href = url;
  });
</script>
{% endblock %}

