{% extends "administrador/base_admin.html" %}

{% block titulo %}Reservas | Admin{% endblock %}
{% block encabezado %}Reservas{% endblock %}

{% block content %}
<style>
  .hero-grad{
    background: linear-gradient(135deg,#2563eb 0%,#22c55e 100%);
    box-shadow: 0 10px 30px rgba(2,6,23,.15);
    border-radius: 18px;
    color:#fff;
  }
  .pill{
    display:inline-flex;align-items:center;gap:.35rem;
    font-weight:600;font-size:.75rem;
    border-radius:999px;padding:.35rem .6rem;
    border:1px solid transparent;
  }
  .pill-c{background:#ecfdf5;color:#16a34a;border-color:#bbf7d0;}
  .pill-p{background:#fff7ed;color:#d97706;border-color:#fed7aa;}
  .pill-x{background:#fef2f2;color:#dc2626;border-color:#fecaca;}
  .pill-d{background:#eef2ff;color:#4338ca;border-color:#c7d2fe;}
  .state-dot{width:.5rem;height:.5rem;border-radius:50%;}
  .dot-c{background:#16a34a}.dot-p{background:#d97706}.dot-x{background:#dc2626}.dot-d{background:#4338ca}

  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.06)}
  .card h3{font-weight:800;margin:0;color:#0f172a}
  .muted{color:#64748b}
  .btn-soft{background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:.55rem .85rem;font-weight:600}
  .btn-primary{background:#2563eb;border:1px solid #1d4ed8;color:#fff}
  .btn-primary:hover{filter:brightness(.98)}
  .table thead th{background:#f8fafc;color:#334155;font-weight:700}
  .table tbody td{vertical-align:middle}
  .form-select,.form-control{border-radius:10px}
</style>

{# =================== HERO + FILTROS (sin expresiones peligrosas) =================== #}
<div class="hero-grad p-4 p-md-5 mb-4">
  <div class="d-flex flex-column flex-xl-row align-items-xl-end justify-content-between gap-3">
    <div>
      <span class="pill" style="background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.35);color:#fff">
        <i class="bi bi-calendar2-check me-1"></i> Gestión de reservas
      </span>
      <h3 class="mt-2">Reservas</h3>
      <p class="mb-0" style="opacity:.85">Administra estados, filtra y busca las reservas de tu comunidad.</p>
    </div>

    <form method="get" class="d-flex flex-column flex-md-row gap-2">
      <div class="input-group">
        <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
        <input type="text" class="form-control" name="q" value="{{ q }}" placeholder="Buscar cliente, clase o email…">
      </div>

      <div class="d-flex gap-2">
        <select name="estado" class="form-select">
          <option value="todos" {% if not estado or estado == "todos" %}selected{% endif %}>Todos</option>
          <option value="confirmada" {% if estado == "confirmada" %}selected{% endif %}>Confirmada</option>
          <option value="pendiente" {% if estado == "pendiente" %}selected{% endif %}>Pendiente</option>
          <option value="cancelada" {% if estado == "cancelada" %}selected{% endif %}>Cancelada</option>
          <option value="completada" {% if estado == "completada" %}selected{% endif %}>Completada</option>
        </select>
        <button class="btn btn-primary"><i class="bi bi-filter me-1"></i> Filtrar</button>
      </div>
    </form>
  </div>
</div>

{# =================== NORMALIZACIÓN DE DATOS (sin includes ni macros) =================== #}
{% if reservas %}
  {% with dataset=reservas %}
    <div class="card p-3">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th style="width:70px">ID</th>
              <th>Cliente</th>
              <th>Clase</th>
              <th style="width:160px">Estado</th>
              <th style="width:120px">Acciones</th>
            </tr>
          </thead>
          <tbody>
          {% for r in dataset %}
            <tr>
              <td class="fw-semibold">{{ r.id }}</td>
              <td>
                {% if r.cliente %}{{ r.cliente }}{% else %}<span class="muted">—</span>{% endif %}
                {% if r.cliente_email %}<div class="small muted">{{ r.cliente_email }}</div>{% endif %}
              </td>
              <td>
                {% if r.clase %}{{ r.clase }}{% else %}<span class="muted">—</span>{% endif %}
                {# Si tuvieses un campo fecha tipo "date", no uses H:i aquí (sólo date) #}
                {# {% if r.fecha %}<div class="small muted">{{ r.fecha|date:"Y-m-d" }}</div>{% endif %} #}
              </td>
              <td>
                {% if r.estado %}
                  {% with s=r.estado|lower %}
                    {% if s == "confirmada" %}
                      <span class="pill pill-c"><span class="state-dot dot-c"></span>Confirmada</span>
                    {% elif s == "pendiente" %}
                      <span class="pill pill-p"><span class="state-dot dot-p"></span>Pendiente</span>
                    {% elif s == "cancelada" %}
                      <span class="pill pill-x"><span class="state-dot dot-x"></span>Cancelada</span>
                    {% elif s == "completada" %}
                      <span class="pill pill-d"><span class="state-dot dot-d"></span>Completada</span>
                    {% else %}
                      <span class="pill" style="background:#f1f5f9;color:#475569;border-color:#e2e8f0">
                        <span class="state-dot" style="background:#94a3b8"></span>{{ r.estado }}
                      </span>
                    {% endif %}
                  {% endwith %}
                {% else %}
                  <span class="pill" style="background:#f1f5f9;color:#475569;border-color:#e2e8f0">
                    <span class="state-dot" style="background:#94a3b8"></span>—
                  </span>
                {% endif %}
              </td>
              <td>
                {% if r.cambiar_url %}
                  <a href="{{ r.cambiar_url }}" class="btn btn-soft btn-sm"><i class="bi bi-sliders"></i> Cambiar</a>
                {% else %}
                  <span class="muted small">—</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5" class="text-center py-4 muted">No hay reservas con los filtros actuales.</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      {% if page_obj %}
        <div class="d-flex justify-content-between align-items-center px-2 py-3">
          <small class="muted">
            Mostrando {{ page_obj.start_index }}–{{ page_obj.end_index }} de {{ page_obj.paginator.count }}
          </small>
          <div class="btn-group">
            {% if page_obj.has_previous %}
              <a class="btn btn-soft btn-sm" href="?{% if q %}q={{ q }}&{% endif %}{% if estado %}estado={{ estado }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
            {% else %}
              <span class="btn btn-soft btn-sm disabled">Anterior</span>
            {% endif %}

            <span class="btn btn-soft btn-sm active">{{ page_obj.number }}</span>

            {% if page_obj.has_next %}
              <a class="btn btn-soft btn-sm" href="?{% if q %}q={{ q }}&{% endif %}{% if estado %}estado={{ estado }}&{% endif %}page={{ page_obj.next_page_number }}">Siguiente</a>
            {% else %}
              <span class="btn btn-soft btn-sm disabled">Siguiente</span>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  {% endwith %}

{% elif object_list %}
  {% with dataset=object_list %}
    <div class="card p-3">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th style="width:70px">ID</th>
              <th>Cliente</th>
              <th>Clase</th>
              <th style="width:160px">Estado</th>
              <th style="width:120px">Acciones</th>
            </tr>
          </thead>
          <tbody>
          {% for r in dataset %}
            <tr>
              <td class="fw-semibold">{{ r.id }}</td>
              <td>
                {% if r.cliente %}{{ r.cliente }}{% else %}<span class="muted">—</span>{% endif %}
                {% if r.cliente_email %}<div class="small muted">{{ r.cliente_email }}</div>{% endif %}
              </td>
              <td>
                {% if r.clase %}{{ r.clase }}{% else %}<span class="muted">—</span>{% endif %}
                {# {% if r.fecha %}<div class="small muted">{{ r.fecha|date:"Y-m-d" }}</div>{% endif %} #}
              </td>
              <td>
                {% if r.estado %}
                  {% with s=r.estado|lower %}
                    {% if s == "confirmada" %}
                      <span class="pill pill-c"><span class="state-dot dot-c"></span>Confirmada</span>
                    {% elif s == "pendiente" %}
                      <span class="pill pill-p"><span class="state-dot dot-p"></span>Pendiente</span>
                    {% elif s == "cancelada" %}
                      <span class="pill pill-x"><span class="state-dot dot-x"></span>Cancelada</span>
                    {% elif s == "completada" %}
                      <span class="pill pill-d"><span class="state-dot dot-d"></span>Completada</span>
                    {% else %}
                      <span class="pill" style="background:#f1f5f9;color:#475569;border-color:#e2e8f0">
                        <span class="state-dot" style="background:#94a3b8"></span>{{ r.estado }}
                      </span>
                    {% endif %}
                  {% endwith %}
                {% else %}
                  <span class="pill" style="background:#f1f5f9;color:#475569;border-color:#e2e8f0">
                    <span class="state-dot" style="background:#94a3b8"></span>—
                  </span>
                {% endif %}
              </td>
              <td>
                {% if r.cambiar_url %}
                  <a href="{{ r.cambiar_url }}" class="btn btn-soft btn-sm"><i class="bi bi-sliders"></i> Cambiar</a>
                {% else %}
                  <span class="muted small">—</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5" class="text-center py-4 muted">No hay reservas con los filtros actuales.</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      {% if page_obj %}
        <div class="d-flex justify-content-between align-items-center px-2 py-3">
          <small class="muted">
            Mostrando {{ page_obj.start_index }}–{{ page_obj.end_index }} de {{ page_obj.paginator.count }}
          </small>
          <div class="btn-group">
            {% if page_obj.has_previous %}
              <a class="btn btn-soft btn-sm" href="?{% if q %}q={{ q }}&{% endif %}{% if estado %}estado={{ estado }}&{% endif %}page={{ page_obj.previous_page_number }}">Anterior</a>
            {% else %}
              <span class="btn btn-soft btn-sm disabled">Anterior</span>
            {% endif %}

            <span class="btn btn-soft btn-sm active">{{ page_obj.number }}</span>

            {% if page_obj.has_next %}
              <a class="btn btn-soft btn-sm" href="?{% if q %}q={{ q }}&{% endif %}{% if estado %}estado={{ estado }}&{% endif %}page={{ page_obj.next_page_number }}">Siguiente</a>
            {% else %}
              <span class="btn btn-soft btn-sm disabled">Siguiente</span>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  {% endwith %}

{% else %}
  <div class="card p-4">
    <p class="mb-0 muted">No hay reservas para mostrar.</p>
  </div>
{% endif %}

{% endblock %}
