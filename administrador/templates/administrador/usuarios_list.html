{% extends "administrador/base_admin.html" %}
{% load static %}

{% block titulo %}Administrar Usuarios | Panel{% endblock %}
{% block encabezado %}Administrar Usuarios{% endblock %}

{% block content %}

<style>
  /* ======= Estética local para esta vista ======= */
  .hero-grad{
    background: linear-gradient(135deg,#1e40af 0%, #2563eb 50%, #06b6d4 100%);
    color:#fff; border:0;
  }
  .hero-grad .btn{
    background: rgba(255,255,255,.14);
    color:#fff; border:1px solid rgba(255,255,255,.25);
  }
  .hero-grad .btn:hover{ background: rgba(255,255,255,.22); color:#fff; }

  .kpi{
    border:1px solid var(--border,#e9eef5);
    background: var(--surface-2,#fff);
    border-radius:16px;
  }
  .kpi .icon{
    width:42px; height:42px; border-radius:999px;
    display:inline-flex; align-items:center; justify-content:center;
    background:#eef2ff; color:#1e40af;
  }

  .filters-card{
    border:1px solid var(--border,#e9eef5);
    background: var(--surface-2,#fff);
    border-radius:16px;
  }

  /* Tabla moderna */
  .table-modern{
    --row-hover: rgba(2,6,23,.05);
    --row-border: var(--border,#e6ebf3);
    border:1px solid var(--row-border);
    border-radius:16px; overflow:hidden;
  }
  .table-modern thead th{
    background:#f8fafc;
    border-bottom:1px solid var(--row-border);
    color:#0f172a; font-weight:700;
  }
  [data-theme="dark"] .table-modern thead th{
    background:#111a30; color:#e5e7eb;
  }
  .table-modern tbody tr:hover{ background:var(--row-hover); }

  /* Badges de rol/estado */
  .role-badge{
    font-weight:700; border-radius:999px; padding:.25rem .5rem; font-size:.8rem;
  }
  .role-admin{ background:#fee2e2; color:#b91c1c; border:1px solid #fecaca; }
  .role-cliente{ background:#dbeafe; color:#1d4ed8; border:1px solid #bfdbfe; }

  .state-ok{ background:#dcfce7; color:#166534; border:1px solid #bbf7d0; }
  .state-off{ background:#e5e7eb; color:#374151; border:1px solid #e5e7eb; }

  /* Botón chip */
  .btn-chip{
    border-radius:999px; padding:.35rem .65rem; font-weight:600;
  }
</style>

{# Alias seguros para evitar errores cuando no hay page_obj/usuarios/object_list #}
{% with po=page_obj ulist=usuarios ol=object_list %}

{% if po %}
  {# ========= Rama con paginación: po.object_list ========= #}
  {% with lista=po.object_list %}

  <!-- ============ HERO ============ -->
  <div class="card hero-grad shadow-sm mb-4 rounded-4">
    <div class="card-body p-4 p-xl-5">
      <div class="d-flex flex-column flex-xl-row align-items-start align-items-xl-center justify-content-between gap-3">
        <div>
          <span class="badge bg-light text-dark fw-semibold mb-2">
            <i class="bi bi-person-gear me-1"></i> Gestión de usuarios
          </span>
          <h1 class="h3 fw-bold mb-1">Panel de administración</h1>
          <p class="mb-0 opacity-75">
            Controla accesos y roles de tu comunidad en <strong>PilatesReserva</strong>.
          </p>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <a href="{% url 'administrador:usuario_crear' %}" class="btn">
            <i class="bi bi-plus-lg me-1"></i> Crear usuario
          </a>
          <div class="btn-group">
            <button class="btn dropdown-toggle" data-bs-toggle="dropdown">
              <i class="bi bi-box-arrow-down me-1"></i> Exportar
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#">CSV</a></li>
              <li><a class="dropdown-item" href="#">XLSX</a></li>
              <li><a class="dropdown-item" href="#">PDF</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ KPIs ============ -->
  <div class="row g-3 mb-4 row-cols-1 row-cols-md-2 row-cols-xl-4">
    <div class="col">
      <div class="kpi p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="small text-secondary">Total usuarios</div>
            <div class="display-6 fw-bold">{{ total_usuarios|default:lista|length }}</div>
          </div>
          <div class="icon"><i class="bi bi-people"></i></div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="kpi p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="small text-secondary">Activos</div>
            <div class="display-6 fw-bold">{{ activos_count|default:"—" }}</div>
          </div>
          <div class="icon" style="background:#dcfce7; color:#166534;"><i class="bi bi-shield-check"></i></div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="kpi p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="small text-secondary">Inactivos</div>
            <div class="display-6 fw-bold">{{ inactivos_count|default:"—" }}</div>
          </div>
          <div class="icon" style="background:#fee2e2; color:#991b1b;"><i class="bi bi-shield-x"></i></div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="kpi p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="small text-secondary">Administradores</div>
            <div class="display-6 fw-bold">{{ admins_count|default:"—" }}</div>
          </div>
          <div class="icon" style="background:#fae8ff; color:#6b21a8;"><i class="bi bi-person-gear"></i></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ FILTROS ============ -->
  <div class="filters-card p-3 p-md-4 mb-3">
    <form method="get" class="row g-2 align-items-center">
      <div class="col-12 col-md-6 col-xl-5">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Buscar username, nombre o email…">
        </div>
      </div>

      <div class="col-6 col-md-3 col-xl-2">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-sort-alpha-down"></i></span>
          <select class="form-select" name="sort">
            <option value="id" {% if sort == "id" %}selected{% endif %}>ID</option>
            <option value="username" {% if sort == "username" %}selected{% endif %}>Username</option>
            <option value="nombre" {% if sort == "nombre" %}selected{% endif %}>Nombre</option>
            <option value="email" {% if sort == "email" %}selected{% endif %}>Email</option>
          </select>
        </div>
      </div>

      <div class="col-6 col-md-3 col-xl-2">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-sort-down"></i></span>
          <select class="form-select" name="dir">
            <option value="asc" {% if dir == "asc" %}selected{% endif %}>Asc</option>
            <option value="desc" {% if dir == "desc" %}selected{% endif %}>Desc</option>
          </select>
        </div>
      </div>

      <div class="col-12 col-md-6 col-xl-3">
        <div class="btn-group w-100" role="group">
          <input type="hidden" name="rol" value="{{ rol }}">
          <a href="?q={{ q|urlencode }}&sort={{ sort }}&dir={{ dir }}" class="btn btn-outline-secondary {% if not rol %}active{% endif %}">
            Todos los roles
          </a>
          <a href="?q={{ q|urlencode }}&sort={{ sort }}&dir={{ dir }}&rol=admin" class="btn btn-outline-danger {% if rol == 'admin' %}active{% endif %}">
            <i class="bi bi-shield-lock me-1"></i> Admin
          </a>
          <a href="?q={{ q|urlencode }}&sort={{ sort }}&dir={{ dir }}&rol=cliente" class="btn btn-outline-primary {% if rol == 'cliente' %}active{% endif %}">
            <i class="bi bi-person-check me-1"></i> Cliente
          </a>
        </div>
      </div>

      <div class="col-12 col-md-6 col-xl-auto">
        <a href="{% url 'administrador:usuarios_list' %}" class="btn btn-outline-secondary">
          <i class="bi bi-eraser me-1"></i> Limpiar
        </a>
      </div>
    </form>
  </div>

  <!-- ============ TABLA ============ -->
  <div class="table-responsive table-modern mb-3">
    <table class="table align-middle mb-0">
      <thead>
      <tr>
        <th style="width:60px;">#</th>
        <th><i class="bi bi-person me-1"></i> Username</th>
        <th><i class="bi bi-person-vcard me-1"></i> Nombre</th>
        <th><i class="bi bi-envelope me-1"></i> Email</th>
        <th style="width:140px;"><i class="bi bi-award me-1"></i> Rol</th>
        <th style="width:120px;"><i class="bi bi-activity me-1"></i> Estado</th>
        <th class="text-end" style="width:160px;">Acciones</th>
      </tr>
      </thead>
      <tbody>
      {% for u in lista %}
        <tr>
          <td class="text-secondary">{{ forloop.counter }}</td>
          <td class="fw-semibold">
            <div class="d-flex align-items-center gap-2">
              <span class="rounded-circle d-inline-flex align-items-center justify-content-center"
                    style="width:28px;height:28px;background:#e2e8f0;color:#1f2937;">
                {{ u.username|first|upper }}
              </span>
              {{ u.username }}
            </div>
          </td>
          <td>
            {% if u.first_name or u.last_name %}
              {{ u.first_name }} {{ u.last_name }}
            {% else %}
              <span class="text-secondary">—</span>
            {% endif %}
          </td>
          <td class="text-secondary">{{ u.email|default:"—" }}</td>

          <td>
            {% with r=u.rol|default_if_none:"" %}
              {% if u.is_superuser or "admin" in r|lower %}
                <span class="role-badge role-admin"><i class="bi bi-shield-lock me-1"></i> administrador</span>
              {% else %}
                <span class="role-badge role-cliente"><i class="bi bi-person-check me-1"></i> cliente</span>
              {% endif %}
            {% endwith %}
          </td>

          <td>
            {% if u.is_active %}
              <span class="role-badge state-ok"><i class="bi bi-check2-circle me-1"></i> Activo</span>
            {% else %}
              <span class="role-badge state-off"><i class="bi bi-slash-circle me-1"></i> Inactivo</span>
            {% endif %}
          </td>

          <td class="text-end">
            <div class="btn-group">
              <a class="btn btn-sm btn-outline-primary btn-chip"
                 href="{% url 'administrador:usuario_editar' u.id %}">
                <i class="bi bi-pencil-square me-1"></i> Editar
              </a>
              {% if not u.is_superuser %}
                <form method="post" action="{% url 'administrador:usuario_toggle_activo' u.id %}"
                      onsubmit="return confirm('¿Seguro que quieres {% if u.is_active %}desactivar{% else %}activar{% endif %} este usuario?');">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-secondary btn-chip" type="submit">
                    {% if u.is_active %}
                      <i class="bi bi-pause-circle me-1"></i> Desactivar
                    {% else %}
                      <i class="bi bi-play-circle me-1"></i> Activar
                    {% endif %}
                  </button>
                </form>
              {% endif %}
            </div>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="7" class="text-center py-4 text-secondary">
            <i class="bi bi-inbox me-2"></i> No hay usuarios que coincidan con tu búsqueda.
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Leyenda + paginación -->
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
    <div class="small text-secondary">
      <span class="role-badge role-admin">Admin</span>
      <span class="role-badge role-cliente ms-2">Cliente</span>
      <span class="role-badge state-ok ms-2">Activo</span>
      <span class="role-badge state-off ms-2">Inactivo</span>
    </div>

    {% if page_obj and page_obj.paginator.num_pages > 1 %}
      <nav aria-label="Paginación">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
            {% if page_obj.has_previous %}
              <a class="page-link"
                 href="?q={{ q|urlencode }}&sort={{ sort }}&dir={{ dir }}&rol={{ rol }}&page={{ page_obj.previous_page_number }}">Anterior</a>
            {% else %}
              <span class="page-link">Anterior</span>
            {% endif %}
          </li>

          {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item">
                <a class="page-link"
                   href="?q={{ q|urlencode }}&sort={{ sort }}&dir={{ dir }}&rol={{ rol }}&page={{ num }}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
            {% if page_obj.has_next %}
              <a class="page-link"
                 href="?q={{ q|urlencode }}&sort={{ sort }}&dir={{ dir }}&rol={{ rol }}&page={{ page_obj.next_page_number }}">Siguiente</a>
            {% else %}
              <span class="page-link">Siguiente</span>
            {% endif %}
          </li>
        </ul>
      </nav>
    {% endif %}
  </div>

  {% endwith %} {# FIN with lista=po.object_list #}

{% else %}
  {# ========= Rama sin paginación: usuarios u object_list ========= #}
  {% with lista=ulist|default:ol %}

  <!-- ======= El mismo contenido que arriba (HERO, KPIs, FILTROS, TABLA, LEYENDA/PAG) ======= -->
  <!-- Para brevedad, es exactamente el MISMO bloque anterior, reutilizando 'lista' en lugar de po.object_list.
       Puedes copiar/pegar el mismo bloque de código entre {# ... #} y mantenerlo idéntico. -->

  <!-- ============ HERO ============ -->
  <div class="card hero-grad shadow-sm mb-4 rounded-4">
    <div class="card-body p-4 p-xl-5">
      <div class="d-flex flex-column flex-xl-row align-items-start align-items-xl-center justify-content-between gap-3">
        <div>
          <span class="badge bg-light text-dark fw-semibold mb-2">
            <i class="bi bi-person-gear me-1"></i> Gestión de usuarios
          </span>
          <h1 class="h3 fw-bold mb-1">Panel de administración</h1>
          <p class="mb-0 opacity-75">
            Controla accesos y roles de tu comunidad en <strong>PilatesReserva</strong>.
          </p>
        </div>
        <div class="d-flex flex-wrap gap-2">
          <a href="{% url 'administrador:usuario_crear' %}" class="btn">
            <i class="bi bi-plus-lg me-1"></i> Crear usuario
          </a>
          <div class="btn-group">
            <button class="btn dropdown-toggle" data-bs-toggle="dropdown">
              <i class="bi bi-box-arrow-down me-1"></i> Exportar
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#">CSV</a></li>
              <li><a class="dropdown-item" href="#">XLSX</a></li>
              <li><a class="dropdown-item" href="#">PDF</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ KPIs ============ -->
  <div class="row g-3 mb-4 row-cols-1 row-cols-md-2 row-cols-xl-4">
    <div class="col">
      <div class="kpi p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="small text-secondary">Total usuarios</div>
            <div class="display-6 fw-bold">{{ total_usuarios|default:lista|length }}</div>
          </div>
          <div class="icon"><i class="bi bi-people"></i></div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="kpi p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="small text-secondary">Activos</div>
            <div class="display-6 fw-bold">{{ activos_count|default:"—" }}</div>
          </div>
          <div class="icon" style="background:#dcfce7; color:#166534;"><i class="bi bi-shield-check"></i></div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="kpi p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="small text-secondary">Inactivos</div>
            <div class="display-6 fw-bold">{{ inactivos_count|default:"—" }}</div>
          </div>
          <div class="icon" style="background:#fee2e2; color:#991b1b;"><i class="bi bi-shield-x"></i></div>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="kpi p-3">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <div class="small text-secondary">Administradores</div>
            <div class="display-6 fw-bold">{{ admins_count|default:"—" }}</div>
          </div>
          <div class="icon" style="background:#fae8ff; color:#6b21a8;"><i class="bi bi-person-gear"></i></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ FILTROS ============ -->
  <div class="filters-card p-3 p-md-4 mb-3">
    <form method="get" class="row g-2 align-items-center">
      <div class="col-12 col-md-6 col-xl-5">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Buscar username, nombre o email…">
        </div>
      </div>

      <div class="col-6 col-md-3 col-xl-2">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-sort-alpha-down"></i></span>
          <select class="form-select" name="sort">
            <option value="id" {% if sort == "id" %}selected{% endif %}>ID</option>
            <option value="username" {% if sort == "username" %}selected{% endif %}>Username</option>
            <option value="nombre" {% if sort == "nombre" %}selected{% endif %}>Nombre</option>
            <option value="email" {% if sort == "email" %}selected{% endif %}>Email</option>
          </select>
        </div>
      </div>

      <div class="col-6 col-md-3 col-xl-2">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-sort-down"></i></span>
          <select class="form-select" name="dir">
            <option value="asc" {% if dir == "asc" %}selected{% endif %}>Asc</option>
            <option value="desc" {% if dir == "desc" %}selected{% endif %}>Desc</option>
          </select>
        </div>
      </div>

      <div class="col-12 col-md-6 col-xl-3">
        <div class="btn-group w-100" role="group">
          <input type="hidden" name="rol" value="{{ rol }}">
          <a href="?q={{ q|urlencode }}&sort={{ sort }}&dir={{ dir }}" class="btn btn-outline-secondary {% if not rol %}active{% endif %}">
            Todos los roles
          </a>
          <a href="?q={{ q|urlencode }}&sort={{ sort }}&dir={{ dir }}&rol=admin" class="btn btn-outline-danger {% if rol == 'admin' %}active{% endif %}">
            <i class="bi bi-shield-lock me-1"></i> Admin
          </a>
          <a href="?q={{ q|urlencode }}&sort={{ sort }}&dir={{ dir }}&rol=cliente" class="btn btn-outline-primary {% if rol == 'cliente' %}active{% endif %}">
            <i class="bi bi-person-check me-1"></i> Cliente
          </a>
        </div>
      </div>

      <div class="col-12 col-md-6 col-xl-auto">
        <a href="{% url 'administrador:usuarios_list' %}" class="btn btn-outline-secondary">
          <i class="bi bi-eraser me-1"></i> Limpiar
        </a>
      </div>
    </form>
  </div>

  <!-- ============ TABLA ============ -->
  <div class="table-responsive table-modern mb-3">
    <table class="table align-middle mb-0">
      <thead>
      <tr>
        <th style="width:60px;">#</th>
        <th><i class="bi bi-person me-1"></i> Username</th>
        <th><i class="bi bi-person-vcard me-1"></i> Nombre</th>
        <th><i class="bi bi-envelope me-1"></i> Email</th>
        <th style="width:140px;"><i class="bi bi-award me-1"></i> Rol</th>
        <th style="width:120px;"><i class="bi bi-activity me-1"></i> Estado</th>
        <th class="text-end" style="width:160px;">Acciones</th>
      </tr>
      </thead>
      <tbody>
      {% for u in lista %}
        <tr>
          <td class="text-secondary">{{ forloop.counter }}</td>
          <td class="fw-semibold">
            <div class="d-flex align-items-center gap-2">
              <span class="rounded-circle d-inline-flex align-items-center justify-content-center"
                    style="width:28px;height:28px;background:#e2e8f0;color:#1f2937;">
                {{ u.username|first|upper }}
              </span>
              {{ u.username }}
            </div>
          </td>
          <td>
            {% if u.first_name or u.last_name %}
              {{ u.first_name }} {{ u.last_name }}
            {% else %}
              <span class="text-secondary">—</span>
            {% endif %}
          </td>
          <td class="text-secondary">{{ u.email|default:"—" }}</td>

          <td>
            {% with r=u.rol|default_if_none:"" %}
              {% if u.is_superuser or "admin" in r|lower %}
                <span class="role-badge role-admin"><i class="bi bi-shield-lock me-1"></i> administrador</span>
              {% else %}
                <span class="role-badge role-cliente"><i class="bi bi-person-check me-1"></i> cliente</span>
              {% endif %}
            {% endwith %}
          </td>

          <td>
            {% if u.is_active %}
              <span class="role-badge state-ok"><i class="bi bi-check2-circle me-1"></i> Activo</span>
            {% else %}
              <span class="role-badge state-off"><i class="bi bi-slash-circle me-1"></i> Inactivo</span>
            {% endif %}
          </td>

          <td class="text-end">
            <div class="btn-group">
              <a class="btn btn-sm btn-outline-primary btn-chip"
                 href="{% url 'administrador:usuario_editar' u.id %}">
                <i class="bi bi-pencil-square me-1"></i> Editar
              </a>
              {% if not u.is_superuser %}
                <form method="post" action="{% url 'administrador:usuario_toggle_activo' u.id %}"
                      onsubmit="return confirm('¿Seguro que quieres {% if u.is_active %}desactivar{% else %}activar{% endif %} este usuario?');">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-secondary btn-chip" type="submit">
                    {% if u.is_active %}
                      <i class="bi bi-pause-circle me-1"></i> Desactivar
                    {% else %}
                      <i class="bi bi-play-circle me-1"></i> Activar
                    {% endif %}
                  </button>
                </form>
              {% endif %}
            </div>
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="7" class="text-center py-4 text-secondary">
            <i class="bi bi-inbox me-2"></i> No hay usuarios que coincidan con tu búsqueda.
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Leyenda -->
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
    <div class="small text-secondary">
      <span class="role-badge role-admin">Admin</span>
      <span class="role-badge role-cliente ms-2">Cliente</span>
      <span class="role-badge state-ok ms-2">Activo</span>
      <span class="role-badge state-off ms-2">Inactivo</span>
    </div>
    {# En esta rama normalmente no hay paginación #}
  </div>

  {% endwith %} {# FIN with lista=ulist|default:ol #}
{% endif %}

{% endwith %} {# FIN alias po/ulist/ol #}

{% endblock %}
